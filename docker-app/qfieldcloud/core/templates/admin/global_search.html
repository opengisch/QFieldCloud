{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; {% trans 'Global Search' %}
</div>
{% endblock %}

{% block content %}
<div id="content-main" class="w-75 mx-auto">
    <h1>{% trans 'Global Search' %}</h1>

    {# Search Form #}
    <div class="module mb-2">
        <form method="get" action="{% url 'admin:global_search' %}" class="p-3">
            <div class="d-flex align-items-center">
                <input
                    type="text"
                    name="q"
                    value="{{ query }}"
                    placeholder="{% trans 'Enter username or email...' %}"
                    class="vTextField flex-grow-1 p-2 mr-2"
                    autofocus>
                <button type="submit" class="button default">{% trans 'Search' %}</button>
            </div>
            <p class="mt-2 text-muted small">
                {% trans 'Tip: Enter an exact username or email address to search across all models.' %}
            </p>
        </form>
    </div>

    {% if query %}
        {# Person Result table #}
        {% if person_result %}
            <div class="card">
                <div class="card-body">
                    <div class="module">
                        <h2 class="p-1 border-bottom">{% trans 'Person' %}</h2>
                        <div class="overflow-auto">
                            <table class="qfc-table">
                                <thead>
                                    <tr>
                                        <th>{% trans 'Username' %}</th>
                                        <th>{% trans 'Email' %}</th>
                                        <th>{% trans 'First Name' %}</th>
                                        <th>{% trans 'Last Name' %}</th>
                                        <th>{% trans 'Date Joined' %}</th>
                                        <th>{% trans 'Actions' %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>{{ person_result.username|default:"-" }}</td>
                                        <td>{{ person_result.email|default:"-" }}</td>
                                        <td>{{ person_result.first_name|default:"-" }}</td>
                                        <td>{{ person_result.last_name|default:"-" }}</td>
                                        <td>{{ person_result.date_joined|date:"M. j, Y, g:i a"|default:"-" }}</td>
                                        <td>
                                            <a href="{% url 'admin:core_person_change' person_result.pk %}"
                                               target="_blank"
                                               class="button">
                                                {% trans 'View' %}
                                            </a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        {# Other Models Results (with pagination) #}
        {% if results %}
            {% for model_key, data in results.items %}
                <div class="card">
                    <div class="card-body">
                        <div class="module">
                            <h2 class="p-1 border-bottom">{{ data.verbose_name_plural|title }}</h2>

                            {% if data.page_obj.object_list %}
                                <div class="overflow-auto">
                                    <table class="qfc-table">
                                        <thead>
                                            <tr>
                                                {% for field_name, field_label in data.fields %}
                                                    <th>{{ field_label }}</th>
                                                {% endfor %}
                                                <th>{% trans 'Actions' %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for obj in data.page_obj %}
                                                <tr>
                                                    {% if model_key == 'organizations' %}
                                                        <td>{{ obj.username|default:"-" }}</td>
                                                        <td>{{ obj.organization_owner|default:"-" }}</td>
                                                        <td>{{ obj.created_at|date:"M. j, Y, g:i a"|default:"-" }}</td>
                                                    {% elif model_key == 'projects' %}
                                                        <td>{{ obj.name|default:"-" }}</td>
                                                        <td>{{ obj.owner|default:"-" }}</td>
                                                        <td>
                                                            {% if obj.is_public %}
                                                                <img src="{% static 'admin/img/icon-yes.svg' %}" alt="True">
                                                            {% else %}
                                                                <img src="{% static 'admin/img/icon-no.svg' %}" alt="False">
                                                            {% endif %}
                                                        </td>
                                                        <td>{{ obj.created_at|date:"M. j, Y, g:i a"|default:"-" }}</td>
                                                    {% elif model_key == 'subscriptions' %}
                                                        <td>{{ obj.id|default:"-" }}</td>
                                                        <td>{{ obj.account.user|default:"-" }}</td>
                                                        <td>{{ obj.plan.display_name|default:"-" }}</td>
                                                        <td>{{ obj.status|default:"-" }}</td>
                                                        <td>{{ obj.active_since|date:"M. j, Y, g:i a"|default:"-" }}</td>
                                                    {% endif %}
                                                    <td>
                                                        <a href="{% url 'admin:'|add:data.app_label|add:'_'|add:data.model_name|add:'_change' obj.pk %}" target="_blank" class="button">
                                                            {% trans 'View' %}
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="p-3">
                                    <p class="text-muted text-center">{% trans 'No results found for this model.' %}</p>
                                </div>
                            {% endif %}

                            {% if data.page_obj.object_list and data.page_obj.has_other_pages %}
                                <p class="paginator d-flex justify-content-between align-items-center mt-2">
                                    <span>
                                        {% blocktrans count counter=data.page_obj.paginator.count %}{{ counter }} result{% plural %}{{ counter }} results{% endblocktrans %}
                                    </span>
                                    <span>
                                    {% if data.page_obj.has_previous %}
                                        <a class="me-1" href="?q={{ query|urlencode }}&{{ data.page_param }}={{ data.page_obj.previous_page_number }}{% for param_name, param_value in request.GET.items %}{% if param_name != 'q' and param_name != data.page_param %}&{{ param_name }}={{ param_value }}{% endif %}{% endfor %}">
                                            &lsaquo; {% trans 'previous' %}
                                        </a>
                                    {% endif %}
                                    {% blocktrans with page=data.page_obj.number total=data.page_obj.paginator.num_pages %}Page {{ page }} of {{ total }}.{% endblocktrans %}
                                    {% if data.page_obj.has_next %}
                                        <a class="ms-1" href="?q={{ query|urlencode }}&{{ data.page_param }}={{ data.page_obj.next_page_number }}{% for param_name, param_value in request.GET.items %}{% if param_name != 'q' and param_name != data.page_param %}&{{ param_name }}={{ param_value }}{% endif %}{% endfor %}">
                                            {% trans 'next' %} &rsaquo;
                                        </a>
                                    {% endif %}
                                    </span>
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endif %}

        {# No results message #}
        {% if not person_result and not results %}
            <div class="module p-3">
                <p class="info">
                    {% blocktrans with query=query %}
                        No results found for "{{ query }}". Please ensure you're using an exact username or email address.
                    {% endblocktrans %}
                </p>
            </div>
        {% endif %}
    {% else %}
        <div class="module p-3">
            <p class="text-muted">
                {% trans 'Enter a username or email address in the search box above to find matching records across Person, Organization, Project, and Subscription models.' %}
            </p>
        </div>
    {% endif %}
</div>
{% endblock %}
